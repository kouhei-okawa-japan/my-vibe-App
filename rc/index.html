<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mono Receipt | AI Expense Tracker</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Import Map for Gemini API -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Inter"', '"Noto Sans JP"', 'sans-serif'],
                    },
                    colors: {
                        mono: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f9fafb;
            color: #1f2937;
            -webkit-font-smoothing: antialiased;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        input[type="file"] { display: none; }
        
        /* Hide number input arrows */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel" data-type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const { useState, useEffect, useRef } = React;

        // --- Icons (Inline SVG) ---
        const ICONS = {
            "scan-line": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 7V5a2 2 0 0 1 2-2h2"/><path d="M17 3h2a2 2 0 0 1 2 2v2"/><path d="M21 17v2a2 2 0 0 1-2 2h-2"/><path d="M7 21H5a2 2 0 0 1-2-2v-2"/><path d="M7 12h10"/></svg>,
            "download": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            "image": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            "camera": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>,
            "chevron-up": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m18 15-6-6-6 6"/></svg>,
            "chevron-down": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m6 9 6 6 6-6"/></svg>,
            "maximize-2": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" x2="14" y1="3" y2="10"/><line x1="3" x2="10" y1="21" y2="14"/></svg>,
            "trash-2": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            "settings": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            "sparkles": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            "x": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 18 18"/></svg>,
            "copy": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>,
            "check": (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const SvgIcon = ICONS[name];
            if (!SvgIcon) return null;
            return <SvgIcon width={size} height={size} className={className} />;
        };

        // --- Helper Functions ---
        const fileToGenerativePart = async (file) => {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        };

        const exportToCSV = (data) => {
            if (data.length === 0) return;
            const headers = ["ID", "日付", "支払先/店舗", "合計金額", "税区分", "消費税額", "支払方法", "カテゴリ", "登録番号", "メモ"];
            const csvContent = [
                headers.join(","),
                ...data.map(item => [
                    item.id,
                    item.date,
                    `"${(item.merchant || "").replace(/"/g, '""')}"`,
                    item.amount,
                    `"${(item.taxRate || "").replace(/"/g, '""')}"`,
                    item.taxAmount || 0,
                    `"${(item.paymentMethod || "").replace(/"/g, '""')}"`,
                    item.category,
                    `"${(item.registration || "").replace(/"/g, '""')}"`,
                    `"${(item.memo || "").replace(/"/g, '""')}"`
                ].join(","))
            ].join("\n");
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `expenses_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- Components ---

        // Custom Input with Copy Button
        const InputWithCopy = ({ label, value, onChange, type = "text", placeholder = "", options = null, readOnly = false }) => {
            const [copied, setCopied] = useState(false);

            const handleCopy = () => {
                if (!value) return;
                
                // Fallback copy method using textarea for broader compatibility (iframe support)
                const textArea = document.createElement("textarea");
                textArea.value = value;
                
                // Ensure it's not visible but part of DOM
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                textArea.style.top = "0";
                document.body.appendChild(textArea);
                
                textArea.focus();
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    if (successful) {
                        setCopied(true);
                        setTimeout(() => setCopied(false), 2000);
                    } else {
                        console.error('Fallback: Copying text command was unsuccessful');
                    }
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                }
                
                document.body.removeChild(textArea);
            };

            return (
                <div className="relative group">
                    <label className="block text-[10px] font-bold text-mono-400 uppercase mb-1">{label}</label>
                    <div className="relative">
                        {options ? (
                            <select 
                                value={value}
                                onChange={onChange}
                                className="w-full bg-mono-50 border border-mono-200 rounded-md pl-2 pr-8 py-1.5 text-sm focus:outline-none focus:border-mono-400 transition-colors appearance-none truncate"
                            >
                                {options.map(opt => (
                                    <option key={opt} value={opt}>{opt}</option>
                                ))}
                            </select>
                        ) : (
                            <input 
                                type={type} 
                                value={value}
                                onChange={onChange}
                                placeholder={placeholder}
                                readOnly={readOnly}
                                className={`w-full bg-mono-50 border border-mono-200 rounded-md pl-2 pr-8 py-1.5 text-sm focus:outline-none focus:border-mono-400 transition-colors ${type === 'number' ? 'text-right' : ''}`}
                            />
                        )}
                        
                        {/* Copy Button */}
                        <button 
                            onClick={handleCopy}
                            className="absolute right-1 top-1/2 -translate-y-1/2 p-1 text-mono-400 hover:text-mono-600 hover:bg-mono-200 rounded transition-colors"
                            title="コピー"
                        >
                            <Icon name={copied ? "check" : "copy"} size={14} className={copied ? "text-green-500" : ""} />
                        </button>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey }) => {
            const [inputVal, setInputVal] = useState(apiKey);

            const handleSave = () => {
                setApiKey(inputVal);
                localStorage.setItem('gemini_api_key', inputVal);
                onClose();
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl scale-100 animate-in zoom-in-95 duration-200">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-bold text-mono-900 flex items-center gap-2">
                                <Icon name="settings" className="w-5 h-5" /> 設定
                            </h2>
                            <button onClick={onClose}><Icon name="x" className="w-5 h-5 text-mono-400" /></button>
                        </div>
                        <div className="mb-4">
                            <label className="block text-sm font-bold text-mono-700 mb-2">Gemini API Key</label>
                            <input 
                                type="password" 
                                value={inputVal}
                                onChange={(e) => setInputVal(e.target.value)}
                                placeholder="AI Studioで取得したキーを入力"
                                className="w-full bg-mono-50 border border-mono-300 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-mono-400"
                            />
                            <p className="text-xs text-mono-500 mt-2">
                                ※キーはブラウザ内にのみ保存されます。<br/>
                                <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-500 underline">APIキーの取得はこちら</a>
                            </p>
                        </div>
                        <button 
                            onClick={handleSave}
                            className="w-full bg-mono-900 text-white font-bold py-3 rounded-xl hover:bg-mono-800 transition-colors"
                        >
                            保存する
                        </button>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [receipts, setReceipts] = useState([]);
            const [isProcessing, setIsProcessing] = useState(false);
            const [processStatus, setProcessStatus] = useState('');
            const [apiKey, setApiKey] = useState('');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const fileInputRef = useRef(null);
            const cameraInputRef = useRef(null);

            useEffect(() => {
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) setApiKey(savedKey);
            }, []);

            const handleFileSelect = async (e) => {
                if (e.target.files && e.target.files[0]) {
                    processImageWithGemini(e.target.files[0]);
                }
                e.target.value = ''; // Reset input
            };

            const processImageWithGemini = async (file) => {
                if (!apiKey) {
                    setIsSettingsOpen(true);
                    return;
                }

                setIsProcessing(true);
                setProcessStatus('画像をAIに送信中...');

                try {
                    const imageUrl = URL.createObjectURL(file);
                    
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });

                    const imagePart = await fileToGenerativePart(file);
                    
                    setProcessStatus('AIがレシートを解析中...');
                    
                    const prompt = `
                    このレシート画像を解析し、以下の情報をJSON形式のみで出力してください。
                    余計なマークダウンや説明は不要です。純粋なJSONテキストだけを返してください。
                    日付は YYYY-MM-DD 形式にしてください。
                    登録番号は T+13桁の番号 を探してください。なければ空文字にしてください。
                    
                    {
                        "date": "日付(YYYY-MM-DD)",
                        "merchant": "店名",
                        "amount": 数字のみ(円マーク等は除く),
                        "tax_amount": "消費税額の合計(数字のみ, 不明なら0)",
                        "tax_rate": "主な税率(10% or 8% or 不明)",
                        "payment_method": "支払い方法(現金, クレジットカード, 電子マネー, QR決済, など。不明なら空文字)",
                        "registration": "登録番号(例: T1234567890123)",
                        "category": "品目から推測される一般的な経費カテゴリ(例: 飲食費, 消耗品費, 交通費)",
                        "memo": "主な品目リスト(カンマ区切り)"
                    }
                    `;

                    const result = await model.generateContent([prompt, imagePart]);
                    const response = await result.response;
                    const text = response.text();

                    const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const parsedData = JSON.parse(jsonString);

                    const newReceipt = {
                        id: Date.now(),
                        date: parsedData.date || new Date().toISOString().slice(0, 10),
                        merchant: parsedData.merchant || '不明',
                        amount: parsedData.amount || 0,
                        taxAmount: parsedData.tax_amount || 0,
                        taxRate: parsedData.tax_rate || '10%',
                        paymentMethod: parsedData.payment_method || '',
                        registration: parsedData.registration || '',
                        category: parsedData.category || '未分類',
                        memo: parsedData.memo || '',
                        image: imageUrl
                    };

                    setReceipts(prev => [newReceipt, ...prev]);
                    setProcessStatus('完了');

                } catch (err) {
                    console.error(err);
                    alert('解析に失敗しました。APIキーが正しいか確認してください。\n' + err.message);
                } finally {
                    setIsProcessing(false);
                    setProcessStatus('');
                }
            };

            const updateReceipt = (id, field, value) => {
                setReceipts(prev => prev.map(r => 
                    r.id === id ? { ...r, [field]: value } : r
                ));
            };

            const deleteReceipt = (id) => {
                if (confirm('削除しますか？')) {
                    setReceipts(prev => prev.filter(r => r.id !== id));
                }
            };

            const totalExpense = receipts.reduce((sum, r) => sum + (Number(r.amount) || 0), 0);

            return (
                <div className="min-h-screen max-w-md mx-auto bg-white shadow-2xl min-h-screen flex flex-col relative overflow-hidden">
                    
                    {/* Header */}
                    <header className="px-6 py-6 bg-white border-b border-mono-200 flex justify-between items-center sticky top-0 z-20 bg-white/90 backdrop-blur-md">
                        <div>
                            <h1 className="text-xl font-bold tracking-tight text-mono-900 flex items-center gap-2">
                                Mono Receipt <span className="bg-mono-900 text-white text-[10px] px-1.5 py-0.5 rounded font-medium">AI</span>
                            </h1>
                            <p className="text-xs text-mono-500 font-medium mt-0.5">Gemini Powered</p>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right">
                                <p className="text-xs text-mono-400 mb-1">合計金額</p>
                                <p className="text-lg font-bold font-mono text-mono-900">
                                    ¥{totalExpense.toLocaleString()}
                                </p>
                            </div>
                            <button onClick={() => setIsSettingsOpen(true)} className="p-2 rounded-full hover:bg-mono-100 transition-colors relative">
                                <Icon name="settings" className="w-5 h-5 text-mono-600" />
                                {!apiKey && <span className="absolute top-1 right-1 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span>}
                            </button>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="flex-1 p-4 overflow-y-auto pb-32">
                        
                        {receipts.length === 0 && !isProcessing ? (
                            <div className="h-64 flex flex-col items-center justify-center text-mono-400 border-2 border-dashed border-mono-200 rounded-2xl mt-4">
                                <Icon name="sparkles" className="w-12 h-12 mb-4 text-mono-300" />
                                <p className="text-sm font-bold text-mono-600">AIでレシートを解析</p>
                                <p className="text-xs mt-1">右下のボタンから撮影してください</p>
                                {!apiKey && (
                                    <button onClick={() => setIsSettingsOpen(true)} className="mt-4 text-xs text-blue-500 underline">
                                        APIキーを設定してください
                                    </button>
                                )}
                            </div>
                        ) : (
                            <div className="space-y-6">
                                {receipts.map(receipt => (
                                    <ReceiptCard 
                                        key={receipt.id} 
                                        data={receipt} 
                                        onUpdate={updateReceipt} 
                                        onDelete={deleteReceipt} 
                                    />
                                ))}
                            </div>
                        )}

                        {/* Processing State */}
                        {isProcessing && (
                            <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-white/80 backdrop-blur-sm">
                                <div className="relative mb-4">
                                    <div className="w-16 h-16 border-4 border-mono-200 border-t-mono-900 rounded-full animate-spin"></div>
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <Icon name="sparkles" className="w-6 h-6 text-mono-900 animate-pulse" />
                                    </div>
                                </div>
                                <p className="text-sm font-bold text-mono-800 animate-pulse">{processStatus}</p>
                            </div>
                        )}

                    </main>

                    {/* Floating Action Bar */}
                    <div className="fixed bottom-0 left-0 w-full max-w-md mx-auto p-4 bg-gradient-to-t from-white via-white to-transparent z-30 pointer-events-none">
                        <div className="flex gap-3 items-end pointer-events-auto">
                            
                            {/* CSV Export Button */}
                            <button 
                                onClick={() => exportToCSV(receipts)}
                                disabled={receipts.length === 0}
                                className="flex-1 bg-white border border-mono-200 text-mono-700 font-medium h-14 rounded-xl shadow-sm flex items-center justify-center gap-2 hover:bg-mono-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-95"
                            >
                                <Icon name="download" className="w-5 h-5" />
                                <span className="text-sm">CSV</span>
                            </button>

                            {/* Add Button Group */}
                            <div className="flex-1 flex gap-2">
                                <button 
                                    onClick={() => fileInputRef.current.click()}
                                    className="flex-1 bg-mono-100 text-mono-800 h-14 rounded-xl shadow-sm flex items-center justify-center hover:bg-mono-200 transition-all active:scale-95"
                                >
                                    <Icon name="image" className="w-6 h-6" />
                                    <input 
                                        type="file" 
                                        ref={fileInputRef} 
                                        accept="image/*" 
                                        onChange={handleFileSelect} 
                                    />
                                </button>

                                <button 
                                    onClick={() => cameraInputRef.current.click()}
                                    className="flex-[1.5] bg-mono-900 text-white h-14 rounded-xl shadow-lg shadow-mono-900/20 flex items-center justify-center gap-2 hover:bg-mono-800 transition-all active:scale-95"
                                >
                                    <Icon name="camera" className="w-6 h-6" />
                                    <span className="font-bold">解析</span>
                                    <input 
                                        type="file" 
                                        ref={cameraInputRef} 
                                        accept="image/*" 
                                        capture="environment" 
                                        onChange={handleFileSelect} 
                                    />
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Settings Modal */}
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)} 
                        apiKey={apiKey} 
                        setApiKey={setApiKey} 
                    />

                </div>
            );
        };

        // Sub-component: Receipt Card
        const ReceiptCard = ({ data, onUpdate, onDelete }) => {
            const [isExpanded, setIsExpanded] = useState(true);
            
            const categories = [
                "未分類", "飲食費", "交通費", "消耗品費", 
                "接待交際費", "会議費", "通信費", "水道光熱費", 
                "旅費交通費", "新聞図書費", "修繕費", "その他"
            ];

            const taxRates = ["10%", "8%", "非課税", "不課税", "免税", "不明"];
            const paymentMethods = ["現金", "クレジットカード", "電子マネー", "QR決済", "振込", "その他", "不明"];

            return (
                <div className="bg-white rounded-xl border border-mono-200 shadow-sm overflow-hidden transition-all hover:shadow-md">
                    {/* Collapsed Header View */}
                    <div 
                        className="p-4 flex justify-between items-start cursor-pointer bg-mono-50/50" 
                        onClick={() => setIsExpanded(!isExpanded)}
                    >
                        <div className="flex gap-3">
                            <div className="w-12 h-12 bg-mono-100 rounded-lg overflow-hidden flex-shrink-0 border border-mono-200 relative group">
                                <img src={data.image} alt="receipt" className="w-full h-full object-cover opacity-90" />
                            </div>
                            <div className="flex-1 min-w-0">
                                <h3 className="font-bold text-mono-800 text-sm leading-tight truncate">{data.merchant}</h3>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="text-[10px] bg-mono-200 text-mono-600 px-1.5 py-0.5 rounded">{data.category}</span>
                                    <p className="text-xs text-mono-500">{data.date}</p>
                                </div>
                            </div>
                        </div>
                        <div className="text-right pl-2">
                            <p className="font-bold text-mono-900 whitespace-nowrap">¥{Number(data.amount).toLocaleString()}</p>
                            <div className="flex justify-end mt-1">
                                <Icon name={isExpanded ? "chevron-up" : "chevron-down"} className="w-4 h-4 text-mono-400" />
                            </div>
                        </div>
                    </div>

                    {/* Expanded Editor View */}
                    {isExpanded && (
                        <div className="p-4 border-t border-mono-100 space-y-3 bg-white animate-in slide-in-from-top-2 duration-200">
                            <div className="grid grid-cols-2 gap-3">
                                <InputWithCopy 
                                    label="日付" 
                                    type="date" 
                                    value={data.date} 
                                    onChange={(e) => onUpdate(data.id, 'date', e.target.value)} 
                                />
                                <InputWithCopy 
                                    label="金額" 
                                    type="number" 
                                    value={data.amount} 
                                    onChange={(e) => onUpdate(data.id, 'amount', e.target.value)} 
                                />
                            </div>

                             <div className="grid grid-cols-2 gap-3">
                                <InputWithCopy 
                                    label="税区分 (主な税率)" 
                                    value={data.taxRate} 
                                    onChange={(e) => onUpdate(data.id, 'taxRate', e.target.value)}
                                    options={taxRates}
                                />
                                <InputWithCopy 
                                    label="消費税額" 
                                    type="number" 
                                    value={data.taxAmount} 
                                    onChange={(e) => onUpdate(data.id, 'taxAmount', e.target.value)} 
                                />
                            </div>

                            <InputWithCopy 
                                label="支払い方法" 
                                value={data.paymentMethod} 
                                onChange={(e) => onUpdate(data.id, 'paymentMethod', e.target.value)}
                                options={paymentMethods}
                            />
                            
                            <InputWithCopy 
                                label="支払先 / 店舗名" 
                                value={data.merchant} 
                                onChange={(e) => onUpdate(data.id, 'merchant', e.target.value)} 
                            />

                            <InputWithCopy 
                                label="インボイス登録番号" 
                                value={data.registration} 
                                onChange={(e) => onUpdate(data.id, 'registration', e.target.value)} 
                                placeholder="T1234567890123"
                            />
                            
                            <InputWithCopy 
                                label="カテゴリ" 
                                value={data.category} 
                                onChange={(e) => onUpdate(data.id, 'category', e.target.value)}
                                options={categories}
                            />
                            
                            <InputWithCopy 
                                label="メモ" 
                                value={data.memo} 
                                onChange={(e) => onUpdate(data.id, 'memo', e.target.value)} 
                            />

                            <div className="flex justify-between items-center pt-2 mt-2 border-t border-dashed border-mono-100">
                                <button 
                                    onClick={() => window.open(data.image, '_blank')}
                                    className="text-xs text-mono-500 hover:text-mono-800 flex items-center gap-1"
                                >
                                    <Icon name="maximize-2" className="w-3 h-3" /> 画像を確認
                                </button>
                                <button 
                                    onClick={() => onDelete(data.id)}
                                    className="text-xs text-red-400 hover:text-red-600 flex items-center gap-1 px-2 py-1 hover:bg-red-50 rounded transition-colors"
                                >
                                    <Icon name="trash-2" className="w-3 h-3" /> 削除
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
